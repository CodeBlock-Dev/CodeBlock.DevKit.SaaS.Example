@using ApexCharts
@using HeyItIsMe.Application.Dtos.PageVisits

@if (IsLoading)
{
    <ComponentLoading />
}
else
{
    <ApexChart @ref="PageChart"
               Height="300"
               TItem="GetPageVisitstByDayDataPointsDto"
               Options="chartOptions">
        @foreach (var series in PageInsights)
        {
            <ApexPointSeries TItem="GetPageVisitstByDayDataPointsDto"
                             Name="@series.Type.GetEnumDisplayName()"
                             SeriesType="SeriesType.Area"
                             XValue="e => e.Date"
                             YValue="e => e.Value"
                             Items="series.Data" />
        }
    </ApexChart>
}

@code {
    protected ApexChart<GetPageVisitstByDayDataPointsDto> PageChart;
    protected IEnumerable<GetPageVisitstByDayDto> PageInsights;
    protected bool IsLoading = true;

    [Parameter]
    public SearchPageVisitsByDayInputDto SearchInputDto { get; set; } = new();

    protected ApexChartOptions<GetPageVisitstByDayDataPointsDto> chartOptions = new()
        {
            Theme = new Theme
            {
                Mode = Mode.Dark,
                Palette = PaletteType.Palette1
            },
            Chart = new Chart
            {
                Background = "transparent",
                ForeColor = "#ffffff"
            },
            Grid = new Grid
            {
                BorderColor = "#2a2a2a"
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        Colors = new List<string> { "#d1d5db" }
                    }
                }
            },
            Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        Colors = new List<string> { "#d1d5db" }
                    }
                }
            }
        },
            Legend = new Legend
            {
                Labels = new LegendLabels
                {
                    Colors = new List<string> { "#d1d5db" }
                }
            }
        };

    protected override async Task OnInitializedAsync()
    {
        await RefreshCharts();
        IsLoading = false;
    }

    public virtual async Task OnSearchChanged(SearchPageVisitsByDayInputDto searchPageVisitsByDayInputDto)
    {
        SearchInputDto = searchPageVisitsByDayInputDto;
        await RefreshCharts();
    }

    protected virtual async Task RefreshCharts()
    {
        await GetPageInsights();
        StateHasChanged();

        if (PageChart != null)
            await PageChart.UpdateSeriesAsync();
    }

    protected virtual async Task GetPageInsights()
    {
        var result = await PageVisitService.GetPageVisitsByDay(SearchInputDto);

        if (result.IsSuccess)
            PageInsights = result.Value.ToList();
        else
            result.ShowErrorToast(ToastService);
    }
}
